var r=class{constructor(){this.events={},this.listenerIds=0,this.listenerMap={}}on(e,s){this.events[e]||(this.events[e]=[]);let o=this.listenerIds++;return this.listenerMap[o]={event:e,listener:s},this.events[e].push(s),()=>this.cancel(o)}once(e,s){let o={fn:null},n=()=>{s.apply(this,arguments),o.fn&&o.fn()};return o.fn=this.on(e,n),o.fn}emit(e,s){if(this.events[e])for(let o of this.events[e])o(s);e!=="*"&&setTimeout(()=>this.emit("*",e,s),1)}off(e,s){this.events[e]&&(this.events[e]=this.events[e].filter(o=>o!==s))}cancel(e){if(e in this.listenerMap){let s=this.listenerMap[e];return this.off(s.event,s.listener),delete this.listenerMap[e],!0}return!1}};var c=class extends r{constructor(e,s,o,n){super(),this.name=e,this.defaultState=this.currentState=s,this.states=o,this.context=n}transition(e){let s=this.states[this.currentState],o=s.events[e];if(o&&this.states[o]){s.exit&&s.exit.call(this,s.output),this.currentState=o;let n=this.states[o];n.entry&&(n.output=n.entry.call(this,this.handleEvent.bind(this)))}else o&&(this.emit(o),this.currentState=this.defaultState)}handleEvent(e){this.transition(e)}};var m=100,d=500;var u=class extends r{constructor(e){super(),this.sm=new c("Button","Idle",D,e),setWatch(()=>{this.sm.handleEvent("_button_pressed"),this.emit("_button_pressed")},BTN,{repeat:!0,edge:"rising",debounce:50}),setWatch(()=>{this.sm.handleEvent("_button_released"),this.emit("_button_released")},BTN,{repeat:!0,edge:"falling",debounce:50}),this.sm.on("*",s=>this.emit(s))}},D={Idle:{events:{_button_pressed:"_PressDetected"},entry:()=>{LED1.write(0),LED2.write(0),LED3.write(0)}},_PressDetected:{events:{_button_released:"_ReleaseBeforeTimeout",_timeout_longClick:"LongClick"},entry:t=>setTimeout(()=>t("_timeout_longClick"),d),exit:clearTimeout},_ReleaseBeforeTimeout:{events:{_button_pressed:"_SecondPressDetected",_timeout_click:"SingleClick"},entry:t=>setTimeout(()=>t("_timeout_click"),m),exit:clearTimeout},_SecondPressDetected:{events:{_button_released:"_ReleaseSecondPressBeforeTimeout",_timeout_longDoubleClick:"LongDoubleClick"},entry:t=>setTimeout(()=>t("_timeout_longDoubleClick"),d),exit:clearTimeout},_ReleaseSecondPressBeforeTimeout:{events:{_button_pressed:"_ThirdPressDetected",_timeout_doubleClick:"DoubleClick"},entry:t=>setTimeout(()=>t("_timeout_doubleClick"),m),exit:clearTimeout},_ThirdPressDetected:{events:{_button_released:"_ReleaseThirdPressBeforeTimeout",_timeout_longTripleClick:"LongTripleClick"},entry:t=>setTimeout(()=>t("_timeout_longTripleClick"),d),exit:clearTimeout},_ReleaseThirdPressBeforeTimeout:{events:{_timeout_tripleClick:"TripleClick"},entry:t=>setTimeout(()=>t("_timeout_tripleClick"),m),exit:clearTimeout}};var h=100;function i(t,e){t.write(1),setTimeout(()=>{e&&e("_timeout_idle")},h)}var a=class{constructor(e){this.sm=new c("Click","Idle",k,e),this.sm.int=require("ble_hid_combo"),e.resetLEDs=()=>{LED1.write(0),LED2.write(0),LED3.write(0)},e.mouseMovementDisabled=!1,e.clicker=this,e.exitMouseControl=!1,this.button=new u(e),this.button.on("*",s=>{this.sm.handleEvent(s),this.sm.emit(s)}),this.sm.on("*",s=>{}),e.resetLEDs()}},k={Idle:{events:{SingleClick:"SingleClick",DoubleClick:"DoubleClick",LongClick:"LongClick",LongDoubleClick:"LongDoubleClick",TripleClick:"TripleClick",LongTripleClick:"LongTripleClick"},entry:function(){this.context.resetLEDs(),global.mouseButtonState=0,this.context.exitMouseControl=!0,this.context.firstClickHappened=!1}},SingleClick:{events:{_timeout_idle:"Idle"},entry:function(t){switch(i(LED1,t),this.context.mode){case"pageupdown":this.context.enableHid&&this.int.tapKey(this.int.KEY.PAGE_DOWN);break;case"rightleft":this.context.enableHid&&this.int.tapKey(this.int.KEY.RIGHT)}}},DoubleClick:{events:{_timeout_idle:"Idle"},entry:function(t){switch(i(LED2,t),this.context.mode){case"pageupdown":this.context.enableHid&&this.int.tapKey(this.int.KEY.PAGE_UP);break;case"rightleft":this.context.enableHid&&this.int.tapKey(this.int.KEY.LEFT)}}},TripleClick:{events:{_timeout_idle:"Idle"},entry:t=>{i(LED1,t),i(LED2,t)}},LongClick:{events:{MouseControl:"MouseControl"},entry:t=>{t("MouseControl")}},MouseControl:{events:{_button_pressed:"_ButtonPressed",LongDoubleClick:"Idle"},entry:function(t){this.context.exitMouseControl=!1,Puck.accelOn(104),i(LED3)},exit:t=>{global.mouseButtonState=0}},_ButtonPressed:{events:{LongDoubleClick:"Idle",LongClick:"Drag",MouseControl:"MouseControl"},entry:function(t){if(this.context.enableHid){if(this.context.mouseMovementDisabled=!0,!this.context.firstClickHappened)global.mouseButtonState=this.int.BUTTON.LEFT,LED1.write(1);else{let e=this.once("_button_released",()=>{global.mouseButtonState=this.int.BUTTON.LEFT,LED1.write(1),setTimeout(()=>{global.mouseButtonState=0,this.context.mouseMovementDisabled=!1,LED1.write(0)},100),setTimeout(()=>{this.context.mouseMovementDisabled=!1,e(),t("MouseControl"),LED1.write(0)},h*5)});return}this.once("_button_released",()=>{LED1.write(0),global.mouseButtonState=0,this.context.firstClickHappened=!0,t("MouseControl"),setTimeout(()=>{this.context.firstClickHappened=!1,this.context.mouseMovementDisabled=!1},h*4)})}}},Drag:{events:{_button_released:"MouseControl"},entry:function(t){this.context.mouseMovementDisabled=!1}},LongDoubleClick:{events:{_timeout_idle:"Idle"},entry:function(t){this.context.mode=this.context.mode==="pageupdown"?"rightleft":"pageupdown",i(LED1,t),i(LED2,t),i(LED3,t)}},LongTripleClick:{events:{_timeout_idle:"Idle"},entry:t=>{reset(),i(LED2,t),i(LED3,t)}}};var _=require("ble_hid_combo");NRF.setServices(void 0,{hid:_.report});NRF.setAdvertising({},{name:"dashClicker",showName:!0,discoverable:!0,services:["0x180f","0x1812"]});var l={},C={mode:"pageupdown",enableHid:!0};function v(){Object.assign(l,C)}v();var P=new a(l),f=0,g=0,b=.5,p=.01;global.sendingHID=!1;global.mouseButtonState=0;Puck.on("accel",t=>{if(global.sendingHID||!l.enableHid)return;if(global.sendingHID=!0,l.exitMouseControl){_.moveMouse(0,0,0,0,0,()=>{global.sendingHID=!1,l.exitMouseControl=!1,Puck.accelOff()});return}let e=f+Math.floor(b*(t.gyro.x*p-f)),s=g+Math.floor(b*(t.gyro.y*p-g));f=e,g=s,l.mouseMovementDisabled;let o=l.mouseMovementDisabled?0:e,n=l.mouseMovementDisabled?0:-s;_.moveMouse(o,n,global.mouseButtonState,0,0,()=>{global.sendingHID=!1})});setTimeout(()=>{LED1.write(1),setTimeout(()=>LED1.write(0),500)},1e3);
